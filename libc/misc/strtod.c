/*
 * Phoenix-RTOS
 *
 * libc-tests
 *
 * Testing POSIX strtod.
 *
 * Copyright 2022 Phoenix Systems
 * Author: Dawid Szpejna
 *
 * This file is part of Phoenix-RTOS.
 *
 * %LICENSE%
 */

#include <unity_fixture.h>
#include <stdlib.h>
#include <errno.h>


TEST_GROUP(strtod_family);


TEST_SETUP(strtod_family)
{
}


TEST_TEAR_DOWN(strtod_family)
{
}


TEST(strtod_family, conversion_to_double_without_E)
{
	TEST_ASSERT_EQUAL_DOUBLE(123123, strtod("123123", NULL));
	TEST_ASSERT_EQUAL_DOUBLE(3.703125, strtod("3.703125", NULL));
	TEST_ASSERT_EQUAL_DOUBLE(.90625, strtod("0.90625", NULL));
	TEST_ASSERT_EQUAL_DOUBLE(0.1234567891234567, strtod("0.1234567891234567", NULL));
}


TEST(strtod_family, conversion_to_double_with_E)
{
	TEST_ASSERT_EQUAL_DOUBLE(3.703125e9, strtod("3.703125e9", NULL));
	TEST_ASSERT_EQUAL_DOUBLE(-.75e+8, strtod("-.75e+8", NULL));
	TEST_ASSERT_EQUAL_DOUBLE(-.75E+8, strtod("-.75E+8", NULL));
	TEST_ASSERT_EQUAL_DOUBLE(0e+19, strtod("0e+19", NULL));
	TEST_ASSERT_EQUAL_DOUBLE(0, strtod(".E2", NULL));
}


TEST(strtod_family, conversion_to_extreme_values)
{
	//Parsing extreme values is imprecise. At now, these tests could not pass on some targets.
	TEST_IGNORE();

	const char num[] =
		"17976931348623157081452742373170435679807056752584499659891747680315"
		"72607800285387605895586327668781715404589535143824642343213268894641"
		"82768467546703537516986049910576551282076245490090389328944075868508"
		"45513394230458323690322294816580855933212334827479782620414472316873"
		"8177180919299881250404026184124858368";

	TEST_ASSERT_EQUAL_DOUBLE(179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.000000,
		strtod(num, NULL));

	TEST_ASSERT_EQUAL_DOUBLE(1.797693134862315e+308, strtod("1.797693134862315e+308", NULL));
	TEST_ASSERT_EQUAL_DOUBLE(-1.797693134862315e+308, strtod("-1.797693134862315e+308", NULL));
	TEST_ASSERT_EQUAL_DOUBLE(-1.00000000000000022204, strtod("-1.00000000000000022204", NULL));
	TEST_ASSERT_EQUAL_DOUBLE(1.00000000000000022204, strtod("1.00000000000000022204", NULL));
	TEST_ASSERT_EQUAL_DOUBLE(2.225073858507201E-308, strtod("2.225073858507201E-308", NULL));
}


TEST(strtod_family, remaining_string)
{
	char *tmp = NULL;
	const char *str;

	str = "    1.797693134862315e+308";
	strtod(str, &tmp);
	TEST_ASSERT_EQUAL_STRING(str + 26, tmp);

	tmp = NULL;
	str = "3.12345Alma mam lkorta";
	strtod(str, &tmp);
	TEST_ASSERT_EQUAL_STRING(str + 7, tmp);

	tmp = NULL;
	str = "    14999   ";
	strtod(str, &tmp);
	TEST_ASSERT_EQUAL_STRING(str + 9, tmp);

	tmp = NULL;
	str = " .875Ealao";
	strtod(str, &tmp);
	TEST_ASSERT_EQUAL_STRING(str + 5, tmp);

	tmp = NULL;
	str = " .875E+testplus";
	strtod(str, &tmp);
	TEST_ASSERT_EQUAL_STRING(str + 5, tmp);

	tmp = NULL;
	str = " .875E-phoenix";
	strtod(str, &tmp);
	TEST_ASSERT_EQUAL_STRING(str + 5, tmp);

	tmp = NULL;
	str = " .875eonlye";
	strtod(str, &tmp);
	TEST_ASSERT_EQUAL_STRING(str + 5, tmp);

	tmp = NULL;
	str = " .875e+ewithplus";
	strtod(str, &tmp);
	TEST_ASSERT_EQUAL_STRING(str + 5, tmp);

	tmp = NULL;
	str = " .875e+ewithminus";
	strtod(str, &tmp);
	TEST_ASSERT_EQUAL_STRING(str + 5, tmp);

	tmp = NULL;
	str = "aaaaaaaaaa";
	strtod(str, &tmp);
	TEST_ASSERT_EQUAL_STRING(str, tmp);

	tmp = NULL;
	str = "-aaaaaaaaaa";
	strtod(str, &tmp);
	TEST_ASSERT_EQUAL_STRING(str, tmp);

	tmp = NULL;
	str = "+aaaaaaaaaa";
	strtod(str, &tmp);
	TEST_ASSERT_EQUAL_STRING(str, tmp);

	tmp = NULL;
	str = "";
	strtod(str, &tmp);
	TEST_ASSERT_EQUAL_STRING(str, tmp);
}

TEST(strtod_family, too_long_numbers)
{
	char *retval = NULL;
	const char num1[] =
		"17976931348623157081452742373170435679807056752584499659891747680315"
		"72607800285387605895586327668781715404589535143824642343213268894641"
		"82768467546703537516986049910576551282076245490090389328944075868508"
		"45513394230458323690322294816580855933212334827479782620414472316873"
		"8177180919299881250404026184124858368123111";
	TEST_ASSERT_DOUBLE_IS_INF(strtod(num1, &retval));
	TEST_ASSERT_EQUAL_STRING("", retval);

	retval = NULL;
	const char num2[] =
		"       17976931348623157081452742373170435679807056752584499659891747680315"
		"72607800285387605895586327668781715404589535143824642343213268894641"
		"82768467546703537516986049910576551282076245490090389328944075868508"
		"45513394230458323690322294816580855933212334827479782620414472316873"
		"817718091929988125040402618412485836812311122222";
	TEST_ASSERT_DOUBLE_IS_INF(strtod(num2, &retval));
	TEST_ASSERT_EQUAL_STRING("", retval);

	retval = NULL;
	const char num3[] =
		"27976931348623157081452742373170435679807056752584499659891747680315"
		"72607800285387605895586327668781715404589535143824642343213268894641"
		"82768467546703537516986049910576551282076245490090389328944075868508"
		"45513394230458323690322294816580855933212334827479782620414472316873"
		"8177180919299881250404026184124858368";
	TEST_ASSERT_DOUBLE_IS_INF(strtod(num3, &retval));
	TEST_ASSERT_EQUAL_STRING("", retval);
}

TEST(strtod_family, errno_test)
{
	errno = 0;
	const char num1[] =
		"17976931348623157081452742373170435679807056752584499659891747680315"
		"72607800285387605895586327668781715404589535143824642343213268894641"
		"82768467546703537516986049910576551282076245490090389328944075868508"
		"45513394230458323690322294816580855933212334827479782620414472316873"
		"8177180919299881250404026184124858368123111";
	strtod(num1, NULL);
	TEST_ASSERT_EQUAL(ERANGE, errno);

	errno = 0;
	const char num2[] = "-2.79769e+308";
	strtod(num2, NULL);
	TEST_ASSERT_EQUAL(ERANGE, errno);

#ifdef phoenix
	errno = 0;
	const char num3[] = "aaaaaaaaa";
	strtod(num3, NULL);
	TEST_ASSERT_EQUAL(EINVAL, errno);

	errno = 0;
	const char num4[] = "";
	strtod(num4, NULL);
	TEST_ASSERT_EQUAL(EINVAL, errno);
#endif

	errno = 0;
	const char num5[] = ".E2";
	strtod(num5, NULL);
	TEST_ASSERT_EQUAL(0, errno);
}


TEST_GROUP_RUNNER(strtod_family)
{
	RUN_TEST_CASE(strtod_family, conversion_to_double_without_E);
	RUN_TEST_CASE(strtod_family, conversion_to_double_with_E);
	RUN_TEST_CASE(strtod_family, conversion_to_extreme_values);
	RUN_TEST_CASE(strtod_family, remaining_string);
	RUN_TEST_CASE(strtod_family, too_long_numbers);
	RUN_TEST_CASE(strtod_family, errno_test);
}
